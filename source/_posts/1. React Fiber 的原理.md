---

title: React åŸºç¡€çŸ¥è¯†ä»¥åŠFiber

category: React

date: 2020-01-02

author: æ—é¸¿é¹„

---

# 1. React Fiber çš„åŸç†

## React Stack
æ˜¯ React 15 ç‰ˆæœ¬çš„ç®—æ³•ï¼Œ æ˜¯ä¸€ä¸ª recursive çš„ç®—æ³•ï¼Œ ä¸èƒ½åœ¨ diffing çš„è¿‡ç¨‹ä¸­åœæ­¢ã€‚

åœ¨react 16 ä¹‹å‰ï¼Œ react ä¼šå»ºç«‹ä¸€ä¸ª DOM æ ‘ï¼Œéœ€è¦æ›´æ–°çš„æ—¶å€™æ˜¯èµ°ä¸€æ­¥æ›´æ–°ä¸€æ­¥ã€‚ä»…ä»…åªæœ‰ä¸€æ£µæ ‘ã€‚ä½†æ˜¯è¿™ä¸ªä¼šæœ‰ä¸€äº›é—®é¢˜ï¼Œ æ¯”å¦‚ concurrent mode å’Œ suspense ä»–ä»¬éœ€è¦èƒ½å¤Ÿåœ¨æ‰“æ–­æ¸²æŸ“è¿‡ç¨‹ç„¶ååšä¸€äº›å…¶ä»–äº‹æƒ…ã€‚

## Reconciler
æ˜¯ react fiber å³ React 16 çš„ç®—æ³•ã€‚

åœ¨ react 16 å’Œä¹‹åï¼Œ å°±åƒå›¾å½¢é‡Œçš„ double buffering ä¸€æ ·ï¼Œreact ä¼šå»ºç«‹ä¸¤ç§æ ‘ï¼Œä¸€ç§æ ‘æ˜¯å½“å‰çš„ DOM ç»“æ„ï¼Œåœ¨èƒŒåå¦ä¸€ç§æ ‘æ˜¯å½“å‰çš„ä¸€ä»½å¤åˆ¶å“ï¼ˆworking progress copyï¼‰ã€‚ä¼šæœ‰ä¸€ä¸ª root node æŒ‡å‘å½“å‰çš„DOMæ ‘ï¼Œç„¶åæ”¹å˜å¤åˆ¶ç‰ˆçš„æ ‘ï¼Œreact åªéœ€è¦æ›¿æ¢ root node çš„æŒ‡å‘å°±å¯ä»¥å®Œæˆæ›¿æ¢ã€‚è¿™ä¸¤æ£µæ ‘ä¼šäº¤æ›¿ä½¿ç”¨ã€‚ä¸ºäº†ä¼˜åŒ–çš„ç›®çš„ï¼Œä¸¤é¢—æ ‘çš„subtree å¯èƒ½æŒ‡å‘ç›¸åŒçš„åœ°æ–¹ã€‚å¦‚æœå¤åˆ¶æ ‘çš„ç»“æ„åœ¨æ”¹å˜çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­äº†ï¼Œreact å¯ä»¥ç›´æ¥ä¸¢å¼ƒæ‰å®ƒï¼Œ å› ä¸ºæˆ‘ä»¬æœ‰ä¸€ä»½æ²¡è¢«åŠ¨è¿‡çš„æ ‘ï¼Œæ‰€ä»¥å¾ˆå¥½çš„å¤åŸã€‚

## React Fiber
æ˜¯ä¸€ä¸ª unit of workï¼Œ fiber å‘Šè¯‰æˆ‘ä»¬å¦‚ä½•å»åˆ†å‰²å·¥ä½œï¼Œ å¦‚ä½•å»ä¼˜å…ˆæ‰§è¡Œå·¥ä½œã€‚ Fiber å¯ä»¥ç›‘ç£æ—¶é—´è¿‡å»äº†å¤šä¹…ã€‚ä¸€åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

#### ç¬¬ä¸€ä¸ªé˜¶æ®µ ï¼ˆrender / reconciliation phaseï¼‰
è‡ªä¸Šè€Œä¸‹ã€‚è¿™ä¸ªé˜¶æ®µä¼šå¼€å§‹åˆ›å»º working progress treeï¼Œæ¥æ‰¾å‡ºä¸€ç³»åˆ—çš„å˜åŒ–ï¼Œä½†æ˜¯ä¸ä¼šå¯¹é‚£äº›å˜åŒ–è¿›è¡Œä¿®æ”¹ï¼Œç›´åˆ°è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚å¯ä»¥è¢«æ‰“æ–­ã€‚

#### ç¬¬äºŒä¸ªé˜¶æ®µ ï¼ˆComplete phaseï¼‰
è‡ªä¸‹è€Œä¸Šã€‚

#### ç¬¬ä¸‰ä¸ªé˜¶æ®µ ï¼ˆCommit phaseï¼‰
flush changesï¼Œgo through all the dom mutations and and life cycle.
fiber + requestIdleCallbackã€‚è¿™ä¸ªé˜¶æ®µä¸èƒ½è¢«æ‰“æ–­ã€‚


## Reconciler Phase
1. componentWillMount 
2. componentWillReceiveProps
3. shouldComponentUpdate
4. componentWillUpdate

## Commit Phase 
1. componentDidMount 
2. componentDidUpdate
3. componentWillUnmount 

## HostRoot
HostRoot æ˜¯ä¸€ä¸ªå®¹å™¨ä½ å¯ä»¥æŠŠä½ çš„ react app æ³¨å°„åˆ° dom é‡Œå»


## RequestIdleCallback

``` bash
window.requestIdleCallback()
```
è¿™ä¸ªæ–¹æ³•å°†åœ¨æµè§ˆå™¨çš„ç©ºé—²æ—¶æ®µå†…è°ƒç”¨çš„å‡½æ•°æ’é˜Ÿã€‚è¿™ä½¿å¼€å‘è€…èƒ½å¤Ÿåœ¨ä¸»äº‹ä»¶å¾ªç¯ä¸Šæ‰§è¡Œåå°å’Œä½ä¼˜å…ˆçº§å·¥ä½œï¼Œè€Œä¸ä¼šå½±å“å»¶è¿Ÿå…³é”®äº‹ä»¶ï¼Œå¦‚åŠ¨ç”»å’Œè¾“å…¥å“åº”ã€‚å‡½æ•°ä¸€èˆ¬ä¼šæŒ‰å…ˆè¿›å…ˆè°ƒç”¨çš„é¡ºåºæ‰§è¡Œï¼Œç„¶è€Œï¼Œå¦‚æœå›è°ƒå‡½æ•°æŒ‡å®šäº†æ‰§è¡Œè¶…æ—¶æ—¶é—´ timeoutï¼Œåˆ™æœ‰å¯èƒ½ä¸ºäº†åœ¨è¶…æ—¶å‰æ‰§è¡Œå‡½æ•°è€Œæ‰“ä¹±æ‰§è¡Œé¡ºåºã€‚

ä»–å»¶è¿Ÿä¸€äº›æ”¹å˜ï¼Œå‘Šè¯‰ä¸»è¿›ç¨‹å½“ä»–æœ‰ç©ºçš„æ—¶å€™å†å»åšã€‚ä¸»è¿›ç¨‹ä¹‹åä¼šå›æ¥æ­å»º working progress treeã€‚ å½“æµè§ˆå™¨æœ‰ç©ºå°±ä¼šè°ƒç”¨ã€‚


## ä¸€ä¸ªå®Œæ•´çš„æµç¨‹å¯ä»¥æ˜¯è¿™æ ·çš„
1. åˆ›å»ºå½“å‰æ ‘ğŸŒ²
2. working progress tree ï¼ˆwip treeï¼‰ ä¼šä» hostRoot é‚£é‡Œå¤åˆ¶ä¸€ä»½æ ‘
3. é‚£äº›èŠ‚ç‚¹ä¼šæŒ‡å‘ hostRoot çš„childrenï¼Œå…±äº«ç›¸åŒçš„ children
4. å¦‚æœæ ‘æ²¡æœ‰æ›´æ–°ï¼Œç›´æ¥å¤åˆ¶ Dom å…ƒç´ 
5. å¦‚æœå­˜åœ¨ä¸€ä¸ªæ›´æ–°é˜Ÿåˆ—ï¼Œ æ›´æ–°é˜Ÿåˆ—å°†ä¼šè¢«å¤åˆ¶åˆ° wip treeã€‚
6. wip tree é‡Œçš„ fiber ä¹‹åä¼šè¢«è¿”å›åˆ°å½“å‰æ ‘ ä½œä¸ºä¸‹ä¸€ä¸ª unit of work
7. work loop å›å»æ£€æŸ¥æ˜¯å¦æœ‰å¤šä½™çš„æ—¶é—´
8. å‡å¦‚æœ‰å¤šä½™çš„æ—¶é—´ï¼Œè€Œä¸”æœ‰æœªå®Œæˆçš„æ›´æ–°ï¼Œé‚£ä¹ˆè¿™æ—¶å€™ä¼šè°ƒç”¨ setState((state,props)=>{})(updater function)
9. å½“æ›´æ–°é˜Ÿåˆ—å®Œæˆï¼Œä¸€ä¸ªç»“æŸçš„ fiber ä¼šå¸¦æœ‰ä¸€ä¸ª tagï¼Œæ¥è¡¨æ˜ dom tree æœ‰æ›´æ–°ã€‚
10. react ä¼šæ£€æŸ¥å­å…ƒç´ çš„ fiber å¯ä¸å¯ä»¥é‡æ–°ä½¿ã€‚å‡å¦‚å¯ä»¥é‡æ–°ä½¿ç”¨ï¼Œreact ä¼šç›´æ¥å…‹éš†åˆ° wip treeã€‚


## SetState
å½“ SetState è¢«è°ƒç”¨äº†ï¼Œreact ä¼šæŠŠæœ€æ–°çš„æ›´æ–°æ”¾åˆ° update queue é‡Œå»ã€‚ä¹‹å react ä¼šæŠŠé‚£äº›å˜åŒ–ä¸€èµ·æ›´æ”¹æ‰ã€‚

``` bash
Component.prototype.setState = function( partialState, callback)
```

- this.state is immutable 
- this.state ä¸ä¸€å®šä¼šç«‹åˆ»æ›´æ–°ï¼Œ åœ¨è¿™ä¹‹åè°ƒç”¨å…¶ä»–å‡½æ•°å¯èƒ½ä¼šè·å¾—æ—§å€¼
- setStateé‡Œçš„å€¼ä¸ä¸€å®šä¼šåŒæ­¥è¿è¡Œï¼Œcallbackå¯ä»¥åœ¨æ‰§è¡Œå®Œæˆåè°ƒç”¨
- callback(preState,props, context) holds up-to-date value 
- å‡½æ•°ä¼šæ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°partialStateæ˜¯å¦æ˜¯ objectï¼Œ function or null
- é‡Œé¢ä¼šè°ƒç”¨ this.updater

## forceUpdate
``` bash
Component.prototype.forceUpdate = function(callback)
```
- å¼ºè¡Œåˆ·æ–°
- å½“ setState æ²¡æœ‰è¢«è°ƒç”¨æ—¶ä½¿ç”¨
- ä¸ä¼šè§¦å‘ shouldComponentUpdate
- ä¼šè§¦å‘ ComponentWillUpdate


## Component 
- è¿”å›ä¸€ä¸ªReact Element
- æœ‰ props, context, refs, updater 
- updater å¯èƒ½æ˜¯ä¼ æ¥çš„updater å‚æ•°æˆ–è€…æ˜¯ ReactNoopUpdateQueue
- æ¯ä¸ªComponentæœ‰è‡ªå·±ç‹¬ç«‹çš„state


